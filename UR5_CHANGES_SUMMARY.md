# Summary of Changes for UR5 Pose Tracking Support

## Files Created

### 1. `launch/ur5_pose_tracking.launch.py`
**Purpose**: Main launch file for UR5 pose tracking with DualSense controller

**Key Features**:
- Loads UR5 robot description using xacro
- Configures fake hardware for simulation
- Launches RViz, robot_state_publisher, ros2_control
- Spawns joint_state_broadcaster and ur_arm_controller
- Starts MoveIt Servo pose tracking
- Integrates DualSense IMU and pose tracking nodes

**Key Parameters**:
- Base frame: `base_link` (UR5 standard)
- End-effector: `tool0` (UR5 standard)
- Controller: `ur_arm_controller`
- Planning group: `ur_manipulator`

### 2. `create_ur5_configs.sh`
**Purpose**: Automated script to generate UR5 configuration files

**What it does**:
- Creates `config/` directory
- Generates `ur5_ros2_controllers.yaml`
- Generates `ur5_servo_config.yaml`
- Checks setup.py for proper config file installation

**Usage**: `./create_ur5_configs.sh`

### 3. `UR5_SETUP.md`
**Purpose**: Comprehensive setup and configuration guide

**Contents**:
- Prerequisites and dependencies
- Step-by-step setup instructions
- Detailed configuration file explanations
- Troubleshooting section
- Comparison table (Panda vs UR5)
- Instructions for real UR5 robot usage

### 4. `QUICKSTART_UR5.md`
**Purpose**: Quick 5-minute getting started guide

**Contents**:
- Minimal steps to get running
- Control mapping reference
- Quick troubleshooting tips
- Instructions for testing without DualSense

### 5. `UR5_CHANGES_SUMMARY.md` (this file)
**Purpose**: Overview of all changes made for UR5 support

## Configuration Files (Generated by Script)

### `config/ur5_ros2_controllers.yaml`
Defines ros2_control configuration:
- Controller manager update rate: 100 Hz
- Joint trajectory controller for UR5's 6 joints:
  - shoulder_pan_joint
  - shoulder_lift_joint
  - elbow_joint
  - wrist_1_joint
  - wrist_2_joint
  - wrist_3_joint
- Joint state broadcaster

### `config/ur5_servo_config.yaml`
MoveIt Servo parameters for UR5:
- Command type: speed_units (m/s, rad/s)
- Velocity limits: 0.4 m/s linear, 0.8 rad/s rotational
- Publish rate: ~29 Hz (0.034s period)
- Planning frame: `base_link`
- End-effector frame: `tool0`
- Group name: `ur_manipulator`
- Controller topic: `/ur_arm_controller/joint_trajectory`
- Collision checking enabled

## Modified Files

### `setup.py`
**Change**: Added config file installation
```python
(os.path.join('share', package_name, 'config'), glob('config/*.yaml')),
```

**Why**: Allows config files to be found by launch files after installation

## Key Differences: Panda → UR5

| Aspect | Panda | UR5 |
|--------|-------|-----|
| Package source | moveit_resources_panda | ur_description |
| Robot description | Pre-built MoveIt config | Generated from xacro |
| Base frame | panda_link0 | base_link |
| End-effector frame | panda_link8 / panda_hand | tool0 |
| Number of joints | 7 | 6 |
| MoveIt group name | panda_arm | ur_manipulator |
| Controller name | panda_arm_controller | ur_arm_controller |
| Joint name pattern | panda_joint1-7 | shoulder_*, elbow_*, wrist_* |

## Usage Instructions

### Step 1: Generate Config Files
```bash
cd ~/ws_moveit2/src/moveit2/dualsense_teleop
chmod +x create_ur5_configs.sh
./create_ur5_configs.sh
```

### Step 2: Build Package
```bash
cd ~/ws_moveit2
colcon build --packages-select dualsense_teleop --symlink-install
source install/setup.bash
```

### Step 3: Launch
```bash
ros2 launch dualsense_teleop ur5_pose_tracking.launch.py
```

## Testing

### Test Without DualSense
```bash
ros2 topic pub /target_pose geometry_msgs/msg/PoseStamped "{
  header: {frame_id: 'base_link'},
  pose: {
    position: {x: 0.3, y: 0.0, z: 0.5},
    orientation: {x: 0.0, y: 0.0, z: 0.0, w: 1.0}
  }
}" --once
```

### Test With DualSense
1. Ensure DualSense controller is connected
2. Launch system (launches IMU and pose tracking automatically)
3. Move controller to control robot orientation
4. Use joysticks for position commands

## Common Issues & Solutions

### Issue: Config files not found
**Solution**: Run `./create_ur5_configs.sh` first

### Issue: Controller not spawning
**Solution**: Wait for ros2_control to initialize, or manually spawn:
```bash
ros2 run controller_manager spawner ur_arm_controller
```

### Issue: TF lookup errors
**Solution**: Check `robot_state_publisher` is running and publishing TF

### Issue: Tracking too slow
**Solution**: Increase PID gains in `moveit_servo/config/pose_tracking_settings.yaml`:
```yaml
x_proportional_gain: 15.0  # Up from 10.0
angular_proportional_gain: 3.0  # Up from 2.0
```

### Issue: Robot moves too fast
**Solution**: Decrease velocity limits in `config/ur5_servo_config.yaml`:
```yaml
scale:
  linear: 0.2  # Down from 0.4
  rotational: 0.4  # Down from 0.8
```

## Architecture

```
DualSense Controller
    ├─ IMU → /dualsense/imu_raw
    └─ Buttons/Sticks (via dualsense library)
           ↓
    IMU Filter (Madgwick)
           ↓
    /imu/data (with orientation)
           ↓
    dualsense_pose_tracking node
           ↓
    /target_pose (geometry_msgs/PoseStamped)
           ↓
    MoveIt Servo PoseTracking (PID control)
           ↓
    /servo_node/delta_twist_cmds (TwistStamped)
           ↓
    MoveIt Servo (IK + safety)
           ↓
    /ur_arm_controller/joint_trajectory
           ↓
    ros2_control (FakeSystem or real hardware)
           ↓
    UR5 Robot (simulated or real)
```

## Dependencies

Required packages:
- `ur_description` (already in workspace)
- `moveit_servo` (already in workspace)
- `dualsense_teleop` (your package)
- `imu_filter_madgwick` (for IMU orientation)
- `controller_manager` (ROS2 control)
- `joint_trajectory_controller` (ROS2 control)

Optional for real robot:
- `Universal_Robots_ROS2_Driver` (for real UR5 hardware)

## Future Enhancements

Possible improvements:
1. Add SRDF generation for MoveIt planning (not just servo)
2. Support for UR gripper/end-effector tools
3. Configurable workspace limits
4. Safety zones configuration
5. Pre-defined poses (home, ready, etc.)
6. Record/playback trajectories from DualSense
7. Force feedback using DualSense haptics

## Notes

- This implementation uses **fake hardware** (simulation) by default
- For real UR5, modify xacro mappings in launch file and provide robot IP
- The UR5 has only 6 DOF (vs Panda's 7), so some orientations may not be reachable
- Collision checking is enabled by default - add scene objects in RViz as needed
- PID gains may need tuning based on your specific use case

## Resources

- [UR Description Package](https://github.com/UniversalRobots/Universal_Robots_ROS2_Description)
- [UR ROS2 Driver](https://github.com/UniversalRobots/Universal_Robots_ROS2_Driver)
- [MoveIt Servo Docs](https://moveit.picknik.ai/main/doc/examples/realtime_servo/realtime_servo_tutorial.html)
- [DualSense Library](https://github.com/yesbotics/dualsense-controller-python)

---

Created: 2025-01-16
For: dualsense_teleop package
Robot: Universal Robots UR5